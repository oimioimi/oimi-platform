<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة OIMI - طلب تقييم</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/cJRw69tq/Favicon-for-OIMI.png">
    <style>
        :root { --p: #00732f; --lg: #f0fff4; }
        body { background: #fdfdfd; margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; padding: 10px; text-align: right; }
        .container { max-width: 600px; margin: auto; }
        .card { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid #eee; }
        
        .main-title { text-align: center; margin-bottom: 15px; font-weight: 800; font-size: 24px; color: #000; }
        .oimi-style { display: inline-flex; align-items: baseline; direction: ltr; font-weight: bold; font-size: 38px; }
        .oimi-i { display: inline-block; background: linear-gradient(to bottom, #ff0000 20%, #000000 20%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* إصلاح مربع خطوات التسجيل */
        .steps-box { background: var(--lg); padding: 15px; border-radius: 12px; border: 1.5px solid var(--p); margin-bottom: 10px; color: #2e7d32; font-size: 14px; line-height: 1.8; }
        .steps-box strong { color: var(--p); font-size: 16px; display: block; margin-bottom: 5px; }
        
        /* التنبيه الأخضر في المنتصف */
        .duplicate-info { color: var(--p); font-size: 13px; font-weight: bold; margin: 10px 0; display: block; text-align: center; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #c3e6cb; }
        
        label { display: block; margin: 15px 0 5px; font-weight: bold; font-size: 14px; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1.5px solid #ddd; box-sizing: border-box; font-size: 15px; background: #fff; font-weight: 600; transition: 0.3s; }
        input:focus { border-color: var(--p); outline: none; background: #f9fffb; }
        .num-input { direction: ltr; text-align: left; }
        input:disabled { background: #f5f5f5 !important; cursor: not-allowed; color: #777; }

        .btn { width: 100%; background: linear-gradient(135deg, #00732f, #00a342); color: white; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 15px rgba(0, 115, 47, 0.2); }
        .btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        
        .separator { border-top: 1px dashed #ccc; margin: 15px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 class="main-title">منصة <span class="oimi-style">O<span class="oimi-i">i</span>M<span class="oimi-i">i</span>.ae</span></h2>
        
        <form id="oimi-form" novalidate> <div class="steps-box">
                <strong>✅ خطوات إتمام الطلب:</strong>
                ١. تحويل رسوم الخدمة (50,000 جنيه) لبنك الخرطوم :4623370 (باسم الأستاذ / عمر إبراهيم).<br>
                ٢. أكمل المعلومات جميعها (الأرقام باللغة الإنجليزية حصراً).<br>
                ٣. اضغط "إرسال" لحفظ بياناتك والحصول على رقم تسجيلك.
            </div>
            
            <div class="duplicate-info">يُسمح بالتسجيل مرة واحدة فقط لكل بريد إلكتروني.</div>

            <label>الاسم الرباعي (بالعربية فقط) *</label>
            <input type="text" id="u_name_ar" placeholder="أدخل الاسم بالعربي" oninput="this.value=this.value.replace(/[a-zA-Z]/g,'')">
            
            <label>الاسم الرباعي (بالإنجليزية فقط) *</label>
            <input type="text" id="u_name_en" class="num-input" placeholder="Full Name in English" oninput="this.value=this.value.replace(/[\u0600-\u06FF]/g,'')">
            
            <label>التخصص المهني *</label>
            <input type="text" id="u_spec" placeholder="مثلاً: مهندس">
            
            <label>بلد الاقامة *</label>
            <select id="u_country" onchange="handleCountryChange(this)">
                <option value="">اختر الدولة...</option>
            </select>
            
            <label>رقم الهاتف *</label>
            <input type="tel" id="u_phone" class="num-input" placeholder="اختر الدولة أولاً" disabled>
            
            <label>رقم الواتساب *</label>
            <input type="tel" id="u_whatsapp" class="num-input" placeholder="اختر الدولة أولاً" disabled>
            
            <label>البريد الالكتروني *</label>
            <input type="email" id="u_email" placeholder="mail@example.com">

            <div class="separator"></div>
            <label>أرفق السيرة الذاتية (PDF أو صورة) *</label>
            <input type="file" id="cv_file" accept=".pdf,image/*">
            
            <label>أرفق صورة إيصال التحويل *</label>
            <input type="file" id="receipt_file" accept="image/*">

            <button type="submit" class="btn" id="submitBtn">إرسال الطلب وحفظ البيانات</button>
        </form>
    </div>
</div>

<script>
// الرابط الخاص بك (الإصدار 88)
const scriptURL = "https://script.google.com/macros/s/AKfycbw0jhOgO2iYIss-Y4_B_hk8WKtFzyUH7FlgLwJijo6iCJ0lchZ_A9dMQAoXxQJo7IAT/exec";

const countryCodes = { "السودان": "00249", "مصر": "0020", "السعودية": "00966", "الإمارات": "00971", "قطر": "00974", "عمان": "00968", "الكويت": "00965", "البحرين": "00973" };
const cSel = document.getElementById('u_country');
Object.keys(countryCodes).sort((a,b)=>a.localeCompare(b,'ar')).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; cSel.appendChild(o); });

function handleCountryChange(el){ 
    const p=document.getElementById('u_phone'), w=document.getElementById('u_whatsapp'); 
    if(el.value){ p.disabled=false; w.disabled=false; p.value=countryCodes[el.value]; w.value=countryCodes[el.value]; } 
}

const form = document.getElementById('oimi-form');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // التحقق اليدوي لضمان الرسائل بالعربية
    const fields = [
        {id: 'u_name_ar', msg: 'يرجى إدخال الاسم بالعربي'},
        {id: 'u_name_en', msg: 'يرجى إدخال الاسم بالإنجليزي'},
        {id: 'u_spec', msg: 'يرجى إدخال التخصص'},
        {id: 'u_country', msg: 'يرجى اختيار بلد الإقامة'},
        {id: 'u_phone', msg: 'يرجى إدخال رقم الهاتف'},
        {id: 'u_whatsapp', msg: 'يرجى إدخال رقم الواتساب'},
        {id: 'u_email', msg: 'يرجى إدخال البريد الإلكتروني بشكل صحيح'},
        {id: 'cv_file', msg: 'يرجى إرفاق السيرة الذاتية'},
        {id: 'receipt_file', msg: 'يرجى إرفاق إيصال التحويل'}
    ];

    for (let f of fields) {
        const el = document.getElementById(f.id);
        if (!el.value || (el.type === 'file' && el.files.length === 0)) {
            alert(f.msg);
            el.focus();
            return;
        }
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.innerHTML = "جاري التحقق من البيانات...";

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    try {
        const payload = {
            "الاسم العربي": document.getElementById('u_name_ar').value,
            "الاسم الانجليزي": document.getElementById('u_name_en').value,
            "التخصص المهني": document.getElementById('u_spec').value,
            "بلد الإقامة": document.getElementById('u_country').value,
            "رقم الهاتف": document.getElementById('u_phone').value,
            "رقم الواتس": document.getElementById('u_whatsapp').value,
            "البريد الإلكتروني": document.getElementById('u_email').value.trim().toLowerCase(),
            "cv_name": document.getElementById('cv_file').files[0].name,
            "cv_data": await toBase64(document.getElementById('cv_file').files[0]),
            "receipt_name": document.getElementById('receipt_file').files[0].name,
            "receipt_data": await toBase64(document.getElementById('receipt_file').files[0])
        };

        const response = await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });
        const result = await response.json();

        if (result.status === "exists") {
            alert("⚠️ تنبيه: لقد تم تسجيلك مسبقاً بهذا البريد الإلكتروني في المنصة. تواصل معنا برقم التسجيل عبر الواتساب.");
            btn.disabled = false; btn.innerHTML = "إرسال الطلب وحفظ البيانات";
        } else if (result.status === "success") {
            alert(`تم استلام طلبك بنجاح ✅\nرقم تسجيلك هو: ${result.uniqueId}`);
            window.open(`https://wa.me/249900065080?text=${encodeURIComponent('تم التسجيل بنجاح. رقمي هو: ' + result.uniqueId)}`, '_blank');
            location.reload();
        } else {
            alert("حدث خطأ غير متوقع: " + result.message);
            btn.disabled = false; btn.innerHTML = "إرسال الطلب";
        }
    } catch (e) {
        alert("فشل الاتصال بالخادم. يرجى المحاولة مرة أخرى.");
        btn.disabled = false; btn.innerHTML = "إرسال الطلب وحفظ البيانات";
    }
});
</script>
</body>
</html>
