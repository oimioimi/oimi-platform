<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbwGIyYpzNy1DmSsiSbDsX2UpaYHpBAmZ0DRchIwgrt6ScSz2OzV1P4Ix8j8v7kHkYa9/exec';

const form = document.getElementById('oimi-form');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.innerHTML = "جاري الحفظ والرفع... يرجى الانتظار";

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    try {
        const cvF = document.getElementById('cv_file').files[0];
        const rcF = document.getElementById('receipt_file').files[0];
        
        const payload = {
            "الاسم العربي": document.getElementById('u_name_ar').value,
            "الاسم الانجليزي": document.getElementById('u_name_en').value,
            "التخصص المهني": document.getElementById('u_spec').value,
            "بلد الإقامة": document.getElementById('u_country').value,
            "رقم الهاتف": document.getElementById('u_phone').value,
            "رقم الواتس": document.getElementById('u_whatsapp').value,
            "البريد الإلكتروني": document.getElementById('u_email').value,
            "ملاحظات": document.getElementById('u_notes').value,
            "كيف سمعت عننا": document.getElementById('u_source').value,
            "cv_data": await toBase64(cvF),
            "cv_name": cvF.name,
            "receipt_data": await toBase64(rcF),
            "receipt_name": rcF.name
        };

        // إرسال البيانات
        await fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload) 
        });

        alert("تم الإرسال بنجاح! سيتم توجيهك الآن للواتساب.");
        window.open(`https://wa.me/249900065080?text=تم إرسال طلبي باسم: ${payload["الاسم العربي"]}`, '_blank');
        location.reload();
        
    } catch (e) {
        alert("حدث خطأ في الاتصال: " + e.message);
        btn.disabled = false; btn.innerHTML = "إرسال الطلب وحفظ البيانات";
    }
});
</script>
