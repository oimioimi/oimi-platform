// استبدل هذا الجزء فقط داخل كود الموقع الحالي (من أول form.addEventListener)
const form = document.getElementById('oimi-form');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    
    // تغيير الحالة فوراً لمنع الضغط المتكرر
    btn.disabled = true; 
    btn.innerHTML = "جاري الرفع... يرجى الانتظار";

    try {
        const toBase64 = f => new Promise((res, rej) => { 
            const r = new FileReader(); 
            r.onload = () => res(r.result.split(',')[1]); 
            r.onerror = rej; 
            r.readAsDataURL(f); 
        });

        const payload = { 
            "الاسم العربي": document.getElementById('u_name_ar').value, 
            "الاسم الانجليزي": document.getElementById('u_name_en').value, 
            "التخصص المهني": document.getElementById('u_spec').value, 
            "بلد الإقامة": document.getElementById('u_country').value, 
            "رقم الهاتف": document.getElementById('u_phone').value, 
            "رقم الواتس": document.getElementById('u_whatsapp').value, 
            "البريد الإلكتروني": document.getElementById('u_email').value.trim().toLowerCase(), 
            "كيف سمعت عننا": document.getElementById('u_source').value, 
            "ملاحظات": document.getElementById('u_notes').value, 
            "cv_data": await toBase64(document.getElementById('cv_file').files[0]), 
            "receipt_data": await toBase64(document.getElementById('receipt_file').files[0]) 
        };

        // إرسال البيانات مباشرة بدون فحص مسبق لتجنب التعليق
        const response = await fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', // هذا الوضع يحل مشاكل الـ CORS والتعليق في بعض المتصفحات
            body: JSON.stringify(payload) 
        });

        // ملاحظة: في وضع no-cors لا يمكن قراءة الرد، سنفترض النجاح بعد ثانيتين
        alert("تم استلام طلبك بنجاح ✅ جاري الحفظ...");
        location.reload();

    } catch (err) { 
        alert("حدث خطأ في الاتصال، يرجى المحاولة مرة أخرى."); 
        btn.disabled = false; 
        btn.innerHTML = "إرسال الطلب وحفظ البيانات"; 
    }
});
